<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Password Generator</title>
  <!-- Scripts -->
  <script src="script/main.js"></script>
  <script src="script/displayerror.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Style -->
  <link rel="stylesheet" href="output.css" />
</head>

<body class="flex flex-col items-center min-w-fit">
  <nav id="navigation" class="flex w-full gap-5 pt-2 px-4 sm:px-8 lg:justify-center bg-white shadow">
    <a href="./password.html">
      <div
        class="flex shrink-0 gap-2 items-center cursor-pointer py-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-b-gray-500">
        <img class="max-w-8 max-h-8" src="icon/dice-five.svg" alt="Password" />
        <h2 class="text-base font-medium sm:block">Password</h2>
      </div>
    </a>
    <a href="./passphrase.html">
      <div
        class="flex shrink-0 gap-2 items-center cursor-pointer py-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-b-gray-500">
        <img class="max-w-8 max-h-8" src="icon/text.svg" alt="Passphrase" />
        <h2 class="text-base font-medium hidden sm:block">Passphrase</h2>
      </div>
    </a>
    <a href="./domain.html">
      <div
        class="flex shrink-0 gap-2 items-center cursor-pointer py-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-b-gray-500">
        <img class="max-w-8 max-h-8" src="icon/globe.svg" alt="Domain" />
        <h2 class="text-base font-medium hidden sm:block">Domain</h2>
      </div>
    </a>
    <a href="./tester.html">
      <div class="flex shrink-0 gap-2 items-center cursor-pointer py-3 border-b-2 border-b-blue-700">
        <img class="max-w-8 max-h-8" src="icon/check-circle.svg" alt="Tester" />
        <h2 class="text-base font-medium hidden sm:block">Tester</h2>
      </div>
    </a>
    <a href="./storage.html">
      <div
        class="flex shrink-0 gap-2 items-center cursor-pointer py-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-b-gray-500">
        <img class="max-w-8 max-h-8" src="icon/lock.svg" alt="Storage" />
        <h2 class="text-base font-medium hidden sm:block">Storage</h2>
      </div>
    </a>
  </nav>
  <div id="content" class="flex flex-col p-4 sm:p-8 max-w-6xl">
    <h1 class="text-2xl sm:text-3xl text-blue-700 font-light">
      Password tester
    </h1>
    <p class="pt-2 font-medium text-gray-700">
      This tool verify the strength of a password by performing two checks.
      Thhe
      <br></br>
      - checks the entropy value of a password <br></br>
      - checks that the password is not present in the Password Databreach of haveibeenpwned.com
    </p>

    <hr class="my-6 text-gray-300" />

    <div class="flex items-center justify-between gap-4 px-4 mb-4">
      <div class="flex flex-col w-full">
        <label class="mb-1 font-semibold text-gray-900">
          Insert Pasword to verify
        </label>
        <input type="text" id="CheckPassword" name="password"
          class="px-3 py-1.5 text-gray-900 border border-gray-500 rounded-md focus-within:outline-blue-600"
          placeholder="Insert Password" />
      </div>
    </div>

    <div class="flex justify-center">
      <button id="generateButton" onclick="RunTest();"
        class="flex justify-center py-2 px-4 sm:min-w-80 gap-2 bg-blue-700 text-white font-semibold hover:bg-blue-600 rounded-md cursor-pointer">
        Run Test
        <img class="w-6 h-6" src="icon/reload.svg" />
      </button>
    </div>

    <div id="errorDisplay" class="hidden items-center gap-4 p-5 mt-4 rounded-md">
      <img id="errorIcon" class="w-8 h-8" src="icon/error.svg" />
      <div id="errorDescription"></div>
    </div>

    <div class="flex justify-center mt-4">
      <canvas id="myChart"></canvas>
    </div>
  </div>

  <script>
    const initialData = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100];

    // Funzione per mappare il valore in un colore (gradiente da rosso a verde)
    function getColor(value) {
      const green = Math.min(255, Math.round((value - 1) * 2.55)); // Dal rosso al verde (scala da 1 a 100)
      const red = 255 - green;
      return `rgb(${red}, ${green}, 0)`; // Colore in formato RGB
    }

    // Funzione per creare i colori basati sui dati
    function generateColors(data) {
      return data.map(value => getColor(value));
    }

    // Creazione del grafico
    const ctx = document.getElementById('myChart').getContext('2d');
    const myChart = new Chart(ctx, {
      type: 'bar', // Tipo di grafico
      data: {
        labels: ['Entropy'], // Etichette (opzionale)
        datasets: [{
          label: 'calculated entropy', // Etichetta del dataset
          data: initialData, // Dati iniziali
          backgroundColor: generateColors(initialData), // Colori dinamici iniziali
          borderColor: generateColors(initialData), // Colore del bordo
          borderWidth: 1
        }]
      },
      options: {
        plugins: {
          legend: {
            display: false // Nascondi la legenda
          }
        },
        indexAxis: 'y', // Orientamento orizzontale
        responsive: true,
        scales: {
          x: {
            beginAtZero: true,
            max: 200 // Limite massimo della scala
          }
        }
      }
    });

    // Funzione per aggiornare il grafico con il nuovo valore dell'input
    function updateChart(entropia) {
      const inputValue = Math.round(entropia); // Ottieni il valore dell'input
      // Aggiorna i dati del grafico con il valore dell'input
      const updatedData = Array(10).fill(inputValue); // Crea un array con il valore dell'input

      // Aggiorna il grafico
      myChart.data.datasets[0].data = updatedData;
      myChart.data.datasets[0].backgroundColor = generateColors(updatedData);
      myChart.data.datasets[0].borderColor = generateColors(updatedData);

      // Aggiorna il grafico
      myChart.update();
    }

    async function RunTest() {
      const password = document.getElementById('CheckPassword').value
      const breach = await checkPasswordCompromised(password);
      const entropia = Math.floor(calcolaEntropia(password));

      // Aggiorno il grafico
      updateChart(entropia);

      // Notifiche di sicurezza
      let description = []
      if (!password.length) {
        setError('icon/error.svg', 'red', 'Error:', ['• The password field is empty.'])
        return;
      }

      description.push(`• The entropy of the password is: ${entropia} bits`)
      if (entropia < 76) {
        description.push('• Password strength: Low.')
      }
      if (breach === null) {
        description.push('• Unable to reach the haveibeenpwned service.')
      }
      if (breach > 0) {
        description.push(`• This password has been compromised ${breach} times.`)
      }
      if (description.length > 1) {
        setError('icon/warning.svg', 'yellow', 'Warning:', description)
        return
      } else {
        description.push('• This password has not been compromised.')
        setError('icon/success.svg', 'green', 'Success.', description)
      }
    }

    async function sha1(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-1', data); // Calcola l'hash
      const hashArray = Array.from(new Uint8Array(hashBuffer)); // Converti in array di byte
      const hashHex = hashArray.map(byte => byte.toString(16).padStart(2, '0')).join(''); // Converti in formato esadecimale
      return hashHex.toUpperCase(); // Restituisci in maiuscolo
    }

    // Funzione per verificare se la password è stata compromessa
    async function checkPasswordCompromised(password) {
      const hash = await sha1(password); // Ottieni l'hash della password
      const prefix = hash.substring(0, 5); // Prendi i primi 5 caratteri dell'hash
      const suffix = hash.substring(5); // Ottieni il resto dell'hash

      // Fai una richiesta all'API di Have I Been Pwned
      const response = await fetch(`https://api.pwnedpasswords.com/range/${prefix}`);

      if (response.ok) {
        const data = await response.text();
        const lines = data.split('\n'); // Dividi i risultati in linee

        // Verifica se il suffisso dell'hash è presente tra i risultati
        for (let line of lines) {
          const [compromisedHash, count] = line.split(':');
          if (compromisedHash === suffix) {
            return count; // La password è stata compromessa
          }
        }
        return '0'; // La password non è stata compromessa
      } else {
        return null; // Errore per connettersi a haveibeenpwned
      }
    }

    function calcolaEntropia(password) {
      // Definisci l'alfabeto disponibile per la password
      const alfabeto = {
        "lowercase": 26, // Lettere minuscole
        "uppercase": 26, // Lettere maiuscole
        "numbers": 10,   // Numeri
        "special": 32    // Caratteri speciali (una stima)
      };

      // Calcola la lunghezza della password
      const lunghezza = password.length;

      // Calcola la dimensione dell'alfabeto (N) basato sulla password
      let alphabetSize = 0;

      if (/[a-z]/.test(password)) alphabetSize += alfabeto.lowercase; // Lettere minuscole
      if (/[A-Z]/.test(password)) alphabetSize += alfabeto.uppercase; // Lettere maiuscole
      if (/[0-9]/.test(password)) alphabetSize += alfabeto.numbers;   // Numeri
      if (/[^a-zA-Z0-9]/.test(password)) alphabetSize += alfabeto.special; // Caratteri speciali

      // Calcola l'entropia in bit
      const entropia = Math.log2(Math.pow(alphabetSize, lunghezza));
      return entropia;
    }
  </script>
</body>

</html>